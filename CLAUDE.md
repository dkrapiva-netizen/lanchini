# CLAUDE.md — Правила для проекта LANCHINI

## О проекте

Статический интернет-магазин подарочных чайных пар. Стек: HTML, CSS, vanilla JS. Заказы отправляются в Telegram через Bot API.

## Структура

- `index.html` — главная страница
- `pages/catalog.html` — каталог с фильтрацией, сортировкой и поиском (инлайн-скрипт)
- `pages/product.html` — страница товара (инлайн-скрипт, рендер через `innerHTML`)
- `pages/cart.html` — корзина (инлайн-скрипт, рендер через `innerHTML`)
- `pages/checkout.html` — оформление заказа, отправка в Telegram (инлайн-скрипт)
- `pages/about.html` — о компании
- `pages/delivery.html` — информация о доставке
- `pages/contacts.html` — контакты
- `js/data.js` — данные товаров (массив `products`)
- `js/cart.js` — модуль корзины (localStorage), глобальный объект `Cart`
- `js/app.js` — общая логика (слайдер, поиск, карточки товаров, уведомления)
- `css/style.css` — все стили проекта (единый файл)
- `images/` — изображения

### Архитектурные особенности

- **Header/footer дублируются** во всех 7 HTML-файлах. Изменение навигации или футера требует правки каждого файла
- Бизнес-логика страниц (каталог, товар, корзина, чекаут) находится в инлайн-`<script>` внутри HTML, а не в отдельных JS-файлах
- Пути к ресурсам различаются: из `index.html` — `pages/catalog.html`, из `pages/` — `../index.html`. Функция `createProductCard` принимает `pathPrefix` для корректных ссылок

## Правила безопасности

### КРИТИЧНО: Секреты и токены

- **НИКОГДА** не добавлять API-токены, пароли, секретные ключи в клиентский код (HTML/JS)
- **Текущий инцидент — токен скомпрометирован:**
  - `TG_TOKEN` и `TG_CHAT_ID` находятся в `pages/checkout.html` в открытом виде
  - Токен зафиксирован в git history (коммиты `434822a`, `c7f8cb2`) — удаление из кода НЕ решает проблему
  - **Любой** с доступом к репозиторию получает полный контроль над ботом: отправка сообщений в любые чаты, чтение обновлений, установка вебхуков
  - **Необходимые действия:** (1) отозвать токен через @BotFather (`/revoke`), (2) создать новый токен, (3) вынести отправку на серверную сторону (Cloudflare Workers, Vercel Functions, свой бэкенд), (4) новый токен хранить ТОЛЬКО в переменных окружения сервера
- Не коммитить файлы `.env`, `credentials.json`, `config.local.*` и подобные
- В `.gitignore` должны быть перечислены все файлы с секретами
- При случайном коммите секрета — **немедленно отзывать** секрет, а не пытаться удалить из истории

### XSS (межсайтовый скриптинг)

- **Не использовать `innerHTML`** для вставки пользовательского ввода. Если данные приходят от пользователя, использовать `textContent` или DOM API
- Всегда экранировать пользовательский ввод перед вставкой в HTML
- Параметры из URL (`search`, `id`) обязательно валидировать и экранировать
- **Текущие места использования `innerHTML` с данными из `data.js`** (допустимо, пока данные контролируются нами; при переходе на внешний API — обязательно санитизировать):
  - `js/app.js` — функция `createProductCard`
  - `pages/product.html` — рендер страницы товара
  - `pages/cart.html` — рендер списка товаров в корзине
  - `pages/catalog.html` — рендер сетки каталога
  - `pages/checkout.html` — сводка заказа

### HTML-инъекция в Telegram-сообщении

- **Текущая проблема:** в `pages/checkout.html` пользовательский ввод (имя, телефон, адрес, комментарий) вставляется в Telegram-сообщение с `parse_mode: 'HTML'` без экранирования HTML-сущностей
- Пользователь может вставить `<b>`, `<script>` и другие теги в поля формы, что сломает форматирование или будет отклонено Telegram API
- **Решение:** перед отправкой экранировать спецсимволы (`<`, `>`, `&`) в пользовательском вводе, либо использовать `parse_mode: 'MarkdownV2'` с соответствующим экранированием

### Формы и ввод

- Валидировать все поля формы оформления заказа (телефон, email, адрес) на стороне клиента И сервера
- Ограничивать длину полей ввода (добавлять `maxlength` на `<input>`)
- **Текущая проблема:** поля в `pages/checkout.html` не имеют `maxlength` — пользователь может отправить сколь угодно длинную строку
- **Текущая проблема:** поле количества товара (`qty`) не имеет верхнего ограничения (`max`) — можно указать любое число

### Целостность данных на клиенте

- **Не доверять данным из `localStorage`** — они могут быть изменены пользователем через DevTools
- **Текущая проблема — `JSON.parse` без try-catch:** в `js/cart.js` строка 7 — `JSON.parse(data)` может выбросить исключение при повреждённых/подменённых данных в localStorage, что роняет весь сайт (вектор DoS). Необходимо обернуть в `try-catch` с fallback на пустой массив
- **Текущая проблема — манипуляция ценами:** пользователь может через DevTools изменить массив `products` (например, `products[0].price = 1`) и оформить заказ. В Telegram придёт сообщение с подменёнными ценами. Пока нет серверной стороны — **нельзя доверять суммам из клиентского кода**. При добавлении бэкенда цены должны пересчитываться на сервере по ID товаров

### Защита от спама заказов

- **Текущая проблема:** единственная защита от повторной отправки формы — `submitBtn.disabled = true`, что обходится через DevTools или прямой запрос к Telegram API (токен открыт в коде)
- Любой может слать сообщения в Telegram-чат напрямую через `curl` с токеном из исходного кода
- **При переходе на серверную отправку** необходимо добавить: rate limiting (по IP / по сессии), CAPTCHA на форму (reCAPTCHA / hCaptcha / Turnstile), защиту от повторной отправки (идемпотентность)

### Общие правила

- Не добавлять внешние скрипты из непроверенных источников
- Ссылки на внешние ресурсы с `target="_blank"` должны содержать `rel="noopener noreferrer"`
- Не использовать `eval()`, `Function()`, `document.write()`
- При добавлении fetch-запросов к внешним API всегда обрабатывать ошибки и таймауты

### HTTP-заголовки безопасности (при деплое на сервер)

При размещении на хостинге/CDN — настроить следующие заголовки:

- `Content-Security-Policy` — ограничить источники скриптов и стилей. Сейчас используются инлайн-скрипты, поэтому потребуется `'unsafe-inline'` или миграция на nonce/hash. Целевое состояние — запретить `'unsafe-inline'` для script-src
- `X-Frame-Options: DENY` — защита от clickjacking (встраивание сайта в iframe)
- `X-Content-Type-Options: nosniff` — запрет MIME-sniffing
- `Referrer-Policy: strict-origin-when-cross-origin` — контроль передачи Referer
- `Permissions-Policy` — отключить неиспользуемые API (camera, microphone, geolocation)

### Целостность внешних ресурсов (SRI)

- Google Fonts загружается без Subresource Integrity — при компрометации CDN возможна подмена стилей/шрифтов
- При добавлении внешних JS-библиотек — **обязательно** указывать `integrity` и `crossorigin` атрибуты на теге `<script>`

### Git

- Перед коммитом проверять, что секреты не попадают в репозиторий
- Не коммитить `.DS_Store`, `node_modules/`, файлы IDE
- **Текущая проблема:** файл `.gitignore` отсутствует — необходимо создать
- Коммиты на русском или английском языке — по согласованию
- **Удаление секрета из git history (`git filter-branch`, `bfg`) НЕ заменяет отзыв секрета.** Если секрет попал в коммит — считать его скомпрометированным и отзывать немедленно, независимо от того, был ли репозиторий публичным
- Если репозиторий когда-либо станет публичным — предварительно провести аудит всей истории на наличие секретов (`git log -p -S 'TOKEN'`)

## Бизнес-константы

Следующие значения захардкожены в нескольких местах. При изменении — обновлять везде:

| Константа | Значение | Где используется |
|---|---|---|
| Порог бесплатной доставки | 5000 руб. | `pages/cart.html`, `pages/checkout.html` |
| Стоимость доставки | 490 руб. | `pages/cart.html`, `pages/checkout.html` |
| Способы доставки | Курьер, Почта России, СДЭК | `pages/checkout.html` |

## Формат данных товара (`js/data.js`)

Каждый товар — объект в массиве `products`:

```js
{
  id: Number,          // уникальный целочисленный ID (автоинкремент)
  name: String,        // название товара
  desc: String,        // короткое описание (для карточки)
  price: Number,       // цена в рублях (целое число)
  image: String,       // HTML-сущность эмодзи (пока нет реальных фото)
  badge: String,       // бейдж ("Хит", "Новинка", "Премиум", или "")
  category: String,    // "women" или "men"
  details: String,     // полное описание (для страницы товара)
  specs: Object        // ключ-значение характеристик
}
```

## Стиль кода

- Язык интерфейса: русский
- CSS: БЭМ-подобная методология (`block__element`, `block__element--modifier`)
- JS: vanilla, без фреймворков. Модули через глобальные объекты (`Cart`, `products`)
- HTML: семантическая разметка, все страницы включают общий header/footer (копипаст, не шаблон)

## Локальная разработка

- Проект статический, сборщика нет. Для просмотра достаточно открыть `index.html` в браузере
- Для корректной работы навигации между страницами рекомендуется локальный сервер: `npx serve .` или `python3 -m http.server`
- Изображений пока нет — вместо них используются эмодзи (HTML-сущности)

## Доступность (a11y)

- Интерактивные элементы (`<button>`) должны иметь `aria-label`, если текст кнопки не описывает действие (пример: бургер-меню уже имеет `aria-label="Меню"`)
- Кнопки изменения количества (`+` / `−`), кнопка поиска и другие иконочные кнопки должны получить `aria-label`
- Изображения товаров (когда появятся реальные фото) должны иметь осмысленный `alt`
- Формы: поля с `required` должны быть визуально отмечены (сейчас отмечены звёздочкой `*` — ок)
